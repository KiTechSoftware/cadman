# Cadman — Data Architecture

> **Audience:** engineers, PMs, ops

> **Purpose:** Define data models, file formats, validation, state transitions, and concurrency rules for Cadman v1.

> **Scope:** `cadman.yaml`, `config.toml`, `apps.toml`, `state.toml`, and JSON outputs.

---

## 1) Overview

Cadman is **config-in / command-out**. All durable data lives on disk as **text files** (YAML/TOML). Runtime outputs are **JSON** (schema-versioned). Concurrency is controlled with **advisory locks** and **atomic writes**.

### 1.1 Data at a Glance

| Artefact      | Format | Scope          | Owner  | Created by         | Read by                    | Written by                |       |          |                             |          |                           |
| ------------- | ------ | -------------- | ------ | ------------------ | -------------------------- | ------------------------- | ----- | -------- | --------------------------- | -------- | ------------------------- |
| `cadman.yaml` | YAML   | per-project    | User   | `cadman init`/user | \`init                     | up                        | down  | purge    | info                        | status\` | `init` (idempotent merge) |
| `config.toml` | TOML   | global or user | Admin  | `cadman install`   | all commands               | `configure` (atomic)      |       |          |                             |          |                           |
| `apps.toml`   | TOML   | per-scope      | Cadman | `app add`          | `app *`, lifecycle, daemon | `app add/remove/purge`    |       |          |                             |          |                           |
| `state.toml`  | TOML   | per-scope      | Cadman | runtime            | \`status                   | logs                      | ports | daemon\` | lifecycle/status collectors |          |                           |
| JSON outputs  | JSON   | per-command    | Cadman | runtime            | humans & CI                | generated by each command |       |          |                             |          |                           |

---

## 2) File Locations

### 2.1 User install (dev)

```
$HOME/.config/cadman/config.toml
$HOME/.cadman/apps.toml
$HOME/.cadman/state.toml
$HOME/.cadman/logs/
<project>/cadman.yaml
```

### 2.2 Global install (server)

```
/etc/cadman/config.toml
/var/lib/cadman/apps.toml
/var/lib/cadman/state.toml
/var/log/cadman/
<project>/cadman.yaml
```

> Permissions (Linux):
> `/etc/cadman` `0750 root:cadman`, `/var/lib/cadman` + `/var/log/cadman` `0750 cadman:cadman`, `$HOME/.cadman` `0700`.

---

## 3) Data Flow

```
cadman.yaml + config.toml (+ ENV + CLI)
         │
         ▼
  Config Resolver ──► Effective Config (in-memory)
         │
         ├─► Podman/Compose (exec) ──► Containers
         ├─► Caddy Config (JSON/Caddyfile) ──► Caddy (reload/rollback)
         ├─► apps.toml (registry ops)
         └─► state.toml (runtime snapshot)
```

**Precedence**: Defaults < Global/User config < ENV (CADMAN\_\*) < CLI flags (wins).

---

## 4) Schemas

> These are **authoritative v1 shapes**. Unknown fields should warn (not fail), unless marked **strict**.

### 4.1 `cadman.yaml` (per-project, YAML)

**Intent:** declarative containers/services and reverse proxy routes.

```yaml
# Required
name: string                        # kebab-case recommended
description: string                 # optional

containers:                         # map<string, Container>
  <key>:
    name: string                    # container name or service label
    image: string                   # OCI image (if not using compose)
    use_compose: boolean            # default: false
    compose_file: string            # when use_compose=true
    working_directory: string       # optional
    detached: boolean               # default: true
    restart: "no"|"on-failure"|"always" # default: "always"
    env_file: [string]              # optional; relative paths allowed
    environment:                    # list or map supported
      - KEY=value
    ports:                          # ["127.0.0.1:HOST:CONTAINER"] or ["HOST:CONTAINER"]
      - "127.0.0.1:1081:80"
    volume: [string]                # e.g., ["$(pwd)/public:/app/public:Z"]
    user: string                    # optional (e.g., "cadman")
    group: string                   # optional
    exec_start: string              # optional
    exec_stop: string               # optional
    after: [string]                 # system deps (hints)
    requires: [string]              # system deps (hints)

caddy:
  email: string                     # optional
  tls: "auto"|"internal"|"off"      # default: "auto"
  routes:
    - host: string|[string]         # domains
      proxy: string                 # upstream, e.g., "127.0.0.1:1081"
      log: "stdout"|"off"           # optional
      tls: "auto"|"internal"|"off"  # optional override
      headers:                      # optional (future)
        - "X-Frame-Options: DENY"
```

**Validation Rules (non-exhaustive)**

* `containers` must be non-empty map.
* If `use_compose=true` → `compose_file` required.
* Each `ports` entry must be `HOST:CONTAINER` or `IP:HOST:CONTAINER` with integers.
* `caddy.routes[*].host` must be FQDN-like or valid local dev alias.
* If `tls=off` globally, route-level `tls` may still override.

---

### 4.2 `config.toml` (global/user, TOML)

**Intent:** platform- and operator-level defaults.

```toml
[global]
debug   = false
verbose = false
quiet   = false
reload  = true
output  = "json"           # table|json|yaml

[mode]
user   = "cadman"          # label only; effective run mode is computed
system = true              # true=global install semantics

[projects]
reload = true
paths  = ["/var/apps", "/opt/apps", "/mnt/apps"]  # discovery paths

[ports]
ranges          = ["3000-3999", "5000-5999"]
prefer_localhost = true
auto_allocate    = true

[logs]
level  = "info"
size   = 100               # MB
output = "file"            # file|stdout|stderr|stacked

[preference]
auto = true                # allow auto choice below

[preference.container]
podman = true
docker = true              # allowed for future; off by default in prod

[preference.compose]
podman_compose = true
docker_compose = true      # allowed if explicitly enabled

[service.caddy]
installed = true
managed   = true
user      = false

[service.podman]
installed = true
managed   = true
user      = true

[service.podman_compose]
installed = true
managed   = true
user      = true
```

**Validation Rules**

* `ports.ranges` each must be `LOW-HIGH` with `LOW<HIGH`.
* `output ∈ {table,json,yaml}`.
* If `system=true` and running as non-root, warn if paths not accessible.

---

### 4.3 `apps.toml` (registry, per-scope, TOML)

**Intent:** authoritative list of Cadman-managed apps in this scope.

```toml
# Array of apps
[[apps]]
app_id   = "01J8X8W6YF9S6W1N9R4E3A7V4B"  # ULID (string)
name     = "cadman-example"             # from cadman.yaml
path     = "/opt/apps/cadman-example"   # project root
status   = "active"                      # active|deleted|not_found
last_seen = 2025-07-05T13:45:00Z         # RFC3339

# Additional entries...
```

**Validation Rules**

* `app_id` must be ULID format (26-char Crockford base32).
* `name` must be unique per-scope; collisions error (`4`).
* `path` must exist and contain `cadman.yaml` to be `active`.

---

### 4.4 `state.toml` (runtime snapshot, per-scope, TOML)

**Intent:** ephemeral view of current runtime; safe to delete; rebuilt as needed.

```toml
["blog-site-02"]               # key is app_id or name alias
container = "cadman-example-01-default"
status    = "running"          # running|stopped|unknown
health    = "healthy"          # healthy|degraded|unhealthy|unknown
started   = "2025-08-10T16:12:03Z"
ports     = [3000, 8000]
caddy_routes = ["blog.local", "www.blog.local"]
caddy_status = "ok"
caddy_route_status = "ok"
caddy_route_health = "healthy"
last_seen = "2025-08-10T16:12:03Z"
```

**Validation Rules**

* Timestamps are UTC RFC3339.
* `status`/`health` are closed enums.
* Missing keys must be tolerated by readers.

---

### 4.5 JSON Outputs (CLI) — Common Envelope

All JSON outputs must include:

```json
{
  "schema_version": "1",
  "data": { /* command-specific */ },
  "meta": {
    "command": "cadman app info --id 01J3…",
    "timestamp": "2025-08-12T20:02:00Z",
    "runmode": "cadman",
    "scope": "global|user"
  }
}
```

* **`schema_version`** changes only on breaking shape changes.
* `meta` may be expanded safely in minor versions.

---

## 5) State Transitions

### 5.1 App Registry (`apps.toml`)

```
           +-----------+
add  ───►  |  active   |
           +-----------+
                │   ▲
    purge --┐   │   │  not_found (path/cadman.yaml missing)
            │   ▼   │  (detected by scan/status/daemon)
            └─►+-----------+
               | not_found |
               +-----------+
                    │
          remove ───┘  (marks deleted) 

deleted entries are eligible for hard purge (erase from file)
```

**Rules**

* `app add`: creates `active`.
* `status/daemon reload`: may flip `active → not_found` if path/YAML missing.
* `app remove`: sets `deleted` (soft). `app purge`: hard delete.

---

## 6) Concurrency & Atomicity (Data-Level)

> Matches SRS/HLD; summarized here for data owners.

### 6.1 Lock Files

* `apps.toml.lock`, `ports.lock`, and `<project>/.cadman.lock`
* Mode: **exclusive** for writes, shared (optional) for reads.
* Backoff + timeout → exit codes **20–22**.

### 6.2 Atomic Write Procedure

1. Write to `*.tmp` alongside target.
2. `fsync(tmp_fd)` then `rename(tmp, real)`.
3. `fsync(parent_dir_fd)` to ensure directory metadata is durable.

### 6.3 Crash Safety

* On crash, either old or new file exists; never torn.
* On startup or next command, validate file and proceed.

---

## 7) Derived Data

* **Effective Config** (in-memory only): result of precedence resolution.
* **Caddy JSON**: generated per command; persisted only if configured to snapshot (future flag).
* **Port Reservations**: persisted as part of registry or state (v1: infer from `state.toml` + project config; v1.x: consider explicit reservation ledger).

---

## 8) Redaction & PII

### 8.1 Redaction Rules

* Redact values if key name matches regexes:
  `(?i)(password|passwd|secret|token|apikey|access[_-]?key|auth|private[_-]?key)`
* Redact env var values from `environment` lists and `env_file` resolution.
* Redaction format: `"***REDACTED***"`.

### 8.2 Logs & Outputs

* JSON outputs and table views must mask secrets.
* `--debug` may show additional **structure**, not secret content.

---

## 9) Validation & Error Codes (Data Layer)

* **`cadman.yaml` invalid** → exit **4** (show line/key & guidance).
* **Missing dependency** preventing use of data → exit **3**.
* **Registry collisions** (duplicate name/app\_id) → exit **4**.
* **Lock timeouts** → exit **20–22** with file path and owning PID (if known).

---

## 10) Migrations

### 10.1 JSON `schema_version`

* **Major** bump on breaking changes (remove/rename/semantics change).
* **Minor** additions allowed (new fields optional).
* Consumers should tolerate unknown fields.

### 10.2 File Formats

* `apps.toml`: add new fields as optional.
* `config.toml`: add defaults in resolver; warn on deprecated keys.
* `cadman.yaml`: accept superset, warn on deprecations.

**Migration Strategy**

* On startup/`doctor`, detect old versions; offer `configure --migrate` to rewrite in-place **after backup**:

  * Create `*.bak.YYYYMMDDHHMMSS`.
  * Rewrite with new keys/defaults.
  * Log summary of changes.

---

## 11) Indexing & Lookups

* **Primary key**: `app_id` (ULID).
* **Alternate keys**: `name`, `path`.
* **Selection precedence**: `--id > --name > --path`.
* **Listing**: stable sort by `name` (then `app_id`).

---

## 12) Examples (Cross-Refs)

* Sample `cadman.yaml` → see **SRS §7.1**.
* Sample `config.toml` → see **SRS §7.2**.
* Sample `apps.toml` → see **SRS §7.3**.
* Sample `state.toml` → see **SRS §7.5**.
* Example JSON outputs → see **SRS §7.4**.

---

## 13) Implementation Notes (Rust)

* Use **serde** with `deny_unknown_fields` for **JSON outputs**; for input files, prefer `serde(deny_unknown_fields)` **off** + explicit manual validation to allow forward compatibility (warn on unknown).
* Normalize time to **UTC** using `chrono` (or `time`) with RFC3339.
* ULIDs via `ulid` crate.
* File IO with **`tempfile` + `fsync`**; locks via `fs2`/`fd-lock` or `nix` (POSIX).
* Backoff with **exponential jitter**; timeouts configurable (env for now).

---

## 14) Open Items (Data)

* Decide whether to **persist explicit port reservations** per app in `apps.toml` for faster `--free` queries (v1.x).
* Optional **SQLite registry** for high-contention environments (v2).
* Pluggable **redaction dictionary** (per org).
* Snapshots of **last-known-good Caddy JSON** per app (opt-in).

---

## 15) Quick Reference (Cheat Sheet)

```
WRITE PATHS (atomic):
- config.toml     via `cadman configure`
- apps.toml       via `cadman app add/remove/purge`
- state.toml      via lifecycle/status collectors

LOCKS:
- apps.toml.lock, ports.lock, <project>/.cadman.lock

KEYS:
- app_id = ULID
- select: --id > --name > --path

TIME:
- UTC RFC3339 everywhere

OUTPUTS:
- JSON with "schema_version": "1"
```
